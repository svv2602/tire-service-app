# Устранение проблем с неактивными торговыми точками

## Проблема

В системе были обнаружены следующие проблемы с работой неактивных торговых точек:

1. **Исчезновение из списка**: При смене статуса точки с активного на неактивный, точка полностью пропадает из списка точек
2. **Недоступность редактирования**: Неактивные точки не отображаются в списке или недоступны для редактирования
3. **Потеря данных**: При обновлении статуса происходит потеря некоторых данных точки

## Причины проблемы

Проблемы вызваны несколькими факторами:

1. **Глобальный скоуп в модели ServicePoint** в Laravel автоматически фильтрует неактивные точки
2. **Отсутствие параметра include_inactive** в некоторых запросах фронтенда
3. **Неправильная обработка ответа API** после изменения статуса
4. **Сложная система двойной фильтрации** на фронтенде (через Redux и локальное состояние)

## Диагностика проблемы

Для диагностики проблемы доступна специальная страница тестирования API:

```
http://localhost:3008/admin/test-api
```

На этой странице перейдите на вкладку "Неактивные точки" и используйте функции:

1. **Запустить диагностику** - проверит API и покажет результаты всех тестов
2. **Исправить видимость неактивных точек** - запустит автоматическое исправление

## Решение проблемы

Комплексное решение включает в себя следующие исправления:

### 1. Улучшенная функция `toggleServicePointActiveStatus`

Мы улучшили функцию переключения статуса в `servicePointStatusToggle.ts`, добавив:
- Улучшенное логирование для отслеживания проблем
- Сохранение и восстановление данных точки
- Дополнительные поля `working_hours` для предотвращения ошибок валидации
- Принудительное использование параметра `include_inactive=true` в URL
- Верификационный запрос после изменения статуса

### 2. Обновление Redux-стейта

Мы улучшили обработку в `servicePointsSlice.ts`:
- Автоматическое обновление всех точек после изменения статуса
- Принудительное включение неактивных точек в ответе
- Сброс фильтров для отображения всех точек
- Повторные запросы для обеспечения актуальности данных

### 3. Улучшенная функция обновления в UI

В `ServicePointsPage.tsx` мы улучшили функцию `handleUpdateServicePoint`:
- Добавили проверку на изменение статуса
- Автоматическое добавление необходимых полей
- Принудительное добавление параметра `include_inactive=true`
- Сброс фильтров после изменения статуса

## Инструкция по ручному исправлению (если автоматическое не помогло)

Если проблема сохраняется, выполните следующие шаги:

1. Перейдите на страницу тестирования API: `http://localhost:3008/admin/test-api`
2. На вкладке "Запросы к API" выберите категорию "Точки обслуживания"
3. Выберите эндпоинт "/api/v2/service-points" (GET)
4. Нажмите "Отправить запрос" и проверьте результат
5. Добавьте параметр `include_inactive=true` в адресной строке или в параметре запроса
6. Проверьте, что неактивные точки появились в ответе API

Если неактивные точки отсутствуют даже с параметром `include_inactive=true`:

1. На вкладке "Неактивные точки" нажмите "Исправить видимость неактивных точек"
2. Проверьте, что операция успешно выполнена
3. Перезагрузите страницу и повторите диагностику

## Дополнительные рекомендации

1. **Бэкенд**: В контроллере ServicePointController убедитесь, что параметр include_inactive корректно обрабатывается
2. **Фронтенд**: При переключении статуса точки следите, что вызываются оба метода:
   - `fetchServicePoints()`
   - `directFetchInactiveServicePoints()`
3. **Интерфейс**: Используйте кнопки фильтрации для явного отображения неактивных точек

## Контакты для поддержки

Если проблема не устраняется, обратитесь к разработчикам. 